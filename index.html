<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Regulamentação Municipal - Nova lei de Licitações e Contratos Públicos</title>
    <link rel="icon" href="pesquisa.png" type="tipo/da-extensao">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }
        .search-section, .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-section input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .search-section button, .filter-section select {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .search-section button:hover, .filter-section select:hover {
            background-color: #2980b9;
        }
        .filter-section select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #resultsContainer, #documentDisplay {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        /* Novo estilo para os "quadrantes" de resultados de cada decreto */
        .decree-results-quadrant {
            background-color: #eaf3f8; /* Um azul bem clarinho para o quadrante */
            border: 1px solid #cce7f4;
            padding: 20px;
            margin-bottom: 25px; /* Espaço entre os quadrantes de decretos diferentes */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .decree-results-quadrant .decree-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            display: block;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db; /* Linha azul para destacar o título do decreto */
        }

        .document-card {
            background-color: #ffffff; /* Fundo branco para o card do artigo dentro do quadrante */
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .document-card .doc-reference {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .document-card .found-paragraph {
            line-height: 1.6;
            margin-top: 10px;
            margin-bottom: 0;
        }
        .highlight {
            background-color: #ffe082; /* Amarelo mais suave */
            padding: 2px 4px;
            border-radius: 3px;
        }
        #documentDisplay h2 {
            text-align: left;
            margin-bottom: 15px;
        }
        #documentDisplay p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .no-results {
            color: #777;
            text-align: center;
            padding: 20px;
        }
        .loading-message {
            text-align: center;
            padding: 20px;
            color: #555;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Consulta Regulamentação Municipal - Nova lei de Licitações e Contratos Públicos</h1>
           <h1>Prefeitura Municipal de Goiana-PE</h1>

        <div class="search-section">
            <input type="text" id="searchInput" placeholder="Buscar por palavra-chave..." aria-label="Palavra-chave para busca">
            <button id="searchButton">Buscar</button>
        </div>

        <div class="filter-section">
            <label for="documentSelector" style="white-space: nowrap;">Ver Documento:</label>
            <select id="documentSelector">
                <option value="">Selecione um decreto/lei</option>
            </select>
        </div>

        <hr>

        <div id="resultsContainer">
            <p class="no-results">Digite uma palavra-chave para iniciar a busca ou selecione um documento acima para visualizá-lo.</p>
        </div>

        <div id="documentDisplay" style="display: none;">
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const documentSelector = document.getElementById('documentSelector');
        const resultsContainer = document.getElementById('resultsContainer');
        const documentDisplay = document.getElementById('documentDisplay');

        // Array para armazenar os documentos carregados
        let loadedDocuments = [];

        // Lista de arquivos de decreto/lei na pasta 'decretos/'
        // ADICIONE AQUI OS NOMES DOS SEUS ARQUIVOS HTML DE DECRETOS/LEIS
        const documentFiles = [
            'DECRETO Nº 007-2024 - REGULAMENTA INEXIGIBILIDADE E DISPENSA.html',
            'DECRETO Nº 027-2024 – REGULA PESQUISA, SISTEMA E LICITAÇÃO NO CRITÉRIO DE MENOR PREÇO.html',
            'DECRETO Nº 038-2024 – REGULA ART. 79 DA LEI 14.133, 1º DE ABRIL 2021, SOBRE CREDENCIAMENTO A CONTRATAÇÃO DE BENS E SERVIÇOS NA ADM PÚBLICA.html',
            'DECRETO Nº 079-2023 - REGULAMENTA A LEI FEDERAL Nº 14.133 NOS ÓRGÃOS E ENTIDADES DA ADMINISTRAÇÃO VINCULADOS AO PODER EXECUTIVO MUNICIPAL.html',
            // Adicione mais nomes de arquivos aqui conforme você criar
        ];

        // Normaliza string (remove acentos e torna minúscula)
        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        async function loadDocuments() {
            resultsContainer.innerHTML = '<p class="loading-message">Carregando documentos...</p>';
            try {
                loadedDocuments = [];
                documentSelector.innerHTML = '<option value="">Selecione um decreto/lei</option>';

                const fetches = documentFiles.map(async file => {
                    try {
                        const response = await fetch(`decretos/${file}`);
                        if (!response.ok) {
                            throw new Error(`Erro ${response.status} ao carregar ${file}: ${response.statusText}`);
                        }
                        const htmlText = await response.text();

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlText, 'text/html');

                        // Título do documento será o nome do arquivo sem a extensão
                        const docTitle = file.replace('.html', '');

                        const textBlocks = [];
                        // Itera sobre todos os nós filhos do body para capturar blocos de texto
                        doc.body.childNodes.forEach(node => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // Priorizamos P, DIV, e cabeçalhos, mas você pode ajustar se seus decretos
                                // usam outras tags para artigos.
                                if (['P', 'DIV', 'H1', 'H2', 'H3', 'LI', 'SPAN'].includes(node.tagName)) {
                                    const originalHtmlContent = node.outerHTML; 
                                    const textContent = node.textContent.trim(); 

                                    if (textContent) {
                                        textBlocks.push({
                                            originalHtml: originalHtmlContent,
                                            normalizedText: normalizeText(textContent)
                                        });
                                    }
                                }
                            } else if (node.nodeType === Node.TEXT_NODE) { 
                                const textContent = node.textContent.trim();
                                if (textContent) {
                                    textBlocks.push({
                                        originalHtml: `<span>${textContent}</span>`, // Envolve texto solto em span
                                        normalizedText: normalizeText(textContent)
                                    });
                                }
                            }
                        });

                        loadedDocuments.push({
                            id: file, // Usar o nome do arquivo como ID
                            title: docTitle,
                            originalFullHtml: htmlText, // Guarda o HTML original completo para exibição completa
                            articles: textBlocks // Armazena os blocos de texto como "artigos"
                        });

                        // Adiciona ao seletor
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = docTitle;
                        documentSelector.appendChild(option);
                    } catch (innerError) {
                        console.error(`Falha ao carregar ou processar o arquivo "${file}":`, innerError);
                        // Poderíamos adicionar uma notificação ao usuário aqui, mas por enquanto, apenas logar.
                    }
                });

                await Promise.all(fetches);
                console.log('Documentos carregados com sucesso!', loadedDocuments);
                // Define a mensagem inicial após o carregamento
                resultsContainer.innerHTML = '<p class="no-results">Digite uma palavra-chave para iniciar a busca ou selecione um documento acima para visualizá-lo.</p>';

            } catch (error) {
                console.error('Erro geral ao carregar documentos:', error);
                resultsContainer.innerHTML = '<p class="no-results" style="color: red;">Erro ao carregar os documentos. Verifique o console para mais detalhes.</p>';
            }
        }

        function performSearch() {
            const searchTerm = normalizeText(searchInput.value.trim());
            resultsContainer.innerHTML = ''; // Limpa resultados anteriores
            documentDisplay.style.display = 'none'; // Oculta a exibição do documento completo
            documentSelector.value = ""; // Limpa a seleção do dropdown

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<p class="no-results">Digite pelo menos 2 caracteres para buscar.</p>';
                return;
            }

            const resultsByDecree = {}; // Objeto para agrupar resultados por decreto

            loadedDocuments.forEach(doc => {
                const docTitle = doc.title;
                const highlightRegex = new RegExp(`(${searchInput.value.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                
                doc.articles.forEach(article => {
                    if (article.normalizedText.includes(searchTerm)) {
                        // Se for a primeira vez que encontramos algo neste decreto, inicializamos o array
                        if (!resultsByDecree[doc.id]) {
                            resultsByDecree[doc.id] = {
                                title: docTitle,
                                foundArticles: []
                            };
                        }

                        // Criar uma cópia do HTML original do artigo para manipular e adicionar o highlight
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = article.originalHtml;

                        // Percorre os nós de texto dentro do elemento para aplicar o highlight
                        const walk = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                        let node;
                        const nodesToReplace = [];

                        while (node = walk.nextNode()) {
                            const originalText = node.nodeValue;
                            const newText = originalText.replace(highlightRegex, '<span class="highlight">$&</span>');
                            if (originalText !== newText) {
                                nodesToReplace.push({ node: node, newText: newText });
                            }
                        }

                        nodesToReplace.forEach(item => {
                            const newNode = document.createElement('span'); 
                            newNode.innerHTML = item.newText;
                            item.node.parentNode.replaceChild(newNode, item.node);
                        });

                        const highlightedArticleHtml = tempDiv.innerHTML;
                        
                        resultsByDecree[doc.id].foundArticles.push(highlightedArticleHtml);
                    }
                });
            });

            let totalFoundArticles = 0;
            // Iterar sobre os resultados agrupados para construir o HTML final
            for (const docId in resultsByDecree) {
                if (resultsByDecree.hasOwnProperty(docId)) {
                    const decreeData = resultsByDecree[docId];
                    totalFoundArticles += decreeData.foundArticles.length;

                    let decreeHtml = `
                        <div class="decree-results-quadrant">
                            <span class="decree-title">Decreto/Lei: ${decreeData.title}</span>
                    `;

                    decreeData.foundArticles.forEach(articleHtml => {
                        // Opcional: Tentar identificar se é um "Artigo" para adicionar um prefixo
                        const tempDivForText = document.createElement('div');
                        tempDivForText.innerHTML = articleHtml;
                        const firstLineText = tempDivForText.textContent.trim().split('\n')[0];
                        let articleLabel = '';
                        if (firstLineText.match(/^(artigo|art)\.?\s+\d+|capítulo|cap\.\s+\d+|parágrafo|parágrafos|seção|seções|§/i)) {
                            // Pega a primeira linha ou um trecho que pareça um título de artigo/seção
                            articleLabel = `<span class="doc-reference">Artigo/Seção:</span>`;
                        } else {
                             // Se não for um artigo claro, apenas um parágrafo que contém o termo
                             articleLabel = `<span class="doc-reference">Trecho relevante:</span>`;
                        }
                        
                        decreeHtml += `
                            <div class="document-card">
                                ${articleLabel}
                                <div class="found-paragraph">${articleHtml}</div>
                            </div>
                        `;
                    });

                    decreeHtml += `</div>`; // Fecha o quadrante do decreto
                    resultsContainer.innerHTML += decreeHtml;
                }
            }

            if (totalFoundArticles === 0) {
                resultsContainer.innerHTML = `<p class="no-results">Nenhum resultado encontrado para "<strong>${searchInput.value}</strong>".</p>`;
            } else {
                resultsContainer.innerHTML = `<h2 style="text-align: left; color: #34495e;">Resultados da busca (${totalFoundArticles} encontrados)</h2>` + resultsContainer.innerHTML;
            }
        }

        // Exibição de Documento Completo
        function displaySelectedDocument() {
            const selectedFile = documentSelector.value;
            resultsContainer.innerHTML = ''; // Limpa resultados da busca
            searchInput.value = ''; // Limpa o campo de busca
            documentDisplay.style.display = 'block'; // Mostra a área de exibição

            if (selectedFile === "") {
                documentDisplay.innerHTML = '<p class="no-results">Selecione um documento para visualizá-lo.</p>';
                return;
            }

            const doc = loadedDocuments.find(d => d.id === selectedFile);
            if (doc) {
                // Exibe o HTML original completo do documento
                documentDisplay.innerHTML = `<div class="document-full-content">${doc.originalFullHtml}</div>`;
            } else {
                documentDisplay.innerHTML = '<p class="no-results" style="color: red;">Erro: Documento não encontrado.</p>';
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', loadDocuments);
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        documentSelector.addEventListener('change', displaySelectedDocument);
    </script>

</body>
</html>
