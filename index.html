<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Regulamentação Municipal - Nova lei de Licitações e Contratos Públicos</title>
    <link rel="icon" href="pesquisa.png" type="image/png"> <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }
        .search-section, .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-section input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .search-section button, .filter-section select {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .search-section button:hover, .filter-section select:hover {
            background-color: #2980b9;
        }
        .filter-section select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #resultsContainer, #documentDisplay {
            border-top: 1px solid #eee;
            padding-top: 20px;
            margin-top: 20px;
        }
        
        /* Novo estilo para os "quadrantes" de resultados de cada decreto */
        .decree-results-quadrant {
            background-color: #eaf3f8; /* Um azul bem clarinho para o quadrante */
            border: 1px solid #cce7f4;
            padding: 20px;
            margin-bottom: 25px; /* Espaço entre os quadrantes de decretos diferentes */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .decree-results-quadrant .decree-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            display: block;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db; /* Linha azul para destacar o título do decreto */
        }

        .document-card {
            background-color: #ffffff; /* Fundo branco para o card do artigo dentro do quadrante */
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .document-card .doc-reference {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .document-card .found-paragraph {
            line-height: 1.6;
            margin-top: 10px;
            margin-bottom: 0;
        }
        .highlight {
            background-color: #ffe082; /* Amarelo mais suave */
            padding: 2px 4px;
            border-radius: 3px;
        }
        #documentDisplay h2 {
            text-align: left;
            margin-bottom: 15px;
        }
        #documentDisplay p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .no-results {
            color: #777;
            text-align: center;
            padding: 20px;
        }
        .loading-message {
            text-align: center;
            padding: 20px;
            color: #555;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Consulta Regulamentação Municipal - Nova lei de Licitações e Contratos Públicos</h1>
            <h1>Prefeitura Municipal de Goiana-PE</h1>

        <div class="search-section">
            <input type="text" id="searchInput" placeholder="Buscar por palavra-chave..." aria-label="Palavra-chave para busca">
            <button id="searchButton">Buscar</button>
        </div>

        <div class="filter-section">
            <label for="documentSelector" style="white-space: nowrap;">Ver Documento:</label>
            <select id="documentSelector">
                <option value="">Selecione um decreto/lei</option>
            </select>
        </div>

        <hr>

        <div id="resultsContainer">
            <p class="no-results">Digite uma palavra-chave para iniciar a busca ou selecione um documento acima para visualizá-lo.</p>
        </div>

        <div id="documentDisplay" style="display: none;">
        </div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const documentSelector = document.getElementById('documentSelector');
        const resultsContainer = document.getElementById('resultsContainer');
        const documentDisplay = document.getElementById('documentDisplay');

        let loadedDocuments = [];

        const documentFiles = [
            'DECRETO Nº 007-2024 - REGULAMENTA INEXIGIBILIDADE E DISPENSA.html',
            'DECRETO Nº 027-2024 – REGULA PESQUISA, SISTEMA E LICITAÇÃO NO CRITÉRIO DE MENOR PREÇO.html',
            'DECRETO Nº 038-2024 – REGULA ART. 79 DA LEI 14.133, 1º DE ABRIL 2021, SOBRE CREDENCIAMENTO A CONTRATAÇÃO DE BENS E SERVIÇOS NA ADM PÚBLICA.html',
            'DECRETO Nº 079-2023 - REGULAMENTA A LEI FEDERAL Nº 14.133 NOS ÓRGÃOS E ENTIDADES DA ADMINISTRAÇÃO VINCULADOS AO PODER EXECUTIVO MUNICIPAL.html',
            
            // Adicione mais nomes de arquivos aqui conforme você criar
        ];

        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        /**
         * Extrai artigos de um documento HTML baseado em padrões de texto.
         * Assume que artigos começam com "Art. [Número]" ou "Artigo [Número]"
         * ou "Capítulo [Número]" ou "Seção [Número]" ou "§ [Número]" (Parágrafo Único)
         * e incluem todos os elementos subsequentes até o próximo padrão de artigo/seção.
         * @param {Document} doc - O objeto Document HTML parseado.
         * @returns {Array<Object>} Uma lista de objetos de artigo, cada um com originalHtml e normalizedText.
         */
        function extractArticles(doc) {
            const articles = [];
            let currentArticleHtml = '';
            let currentArticleText = '';
            let isInsideArticle = false; // Flag para saber se estamos dentro de um artigo

            // Regex para identificar o início de um novo artigo, parágrafo único, capítulo ou seção.
            // Ajuste esta regex para ser o mais preciso possível para a estrutura dos seus documentos.
            const articleStartRegex = /^(artigo|art)\.?\s+\d+|capítulo\s+\w+|seção\s+\w+|parágrafo\s+único|parágrafo|§\s+\d+/i;

            // Coleta todos os elementos de bloco que podem conter texto de artigos
            const potentialBlocks = doc.body.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, li, span'); 

            potentialBlocks.forEach(node => {
                const textContent = node.textContent.trim();
                const outerHtml = node.outerHTML;

                if (!textContent) {
                    // Ignora elementos vazios
                    return;
                }

                // Tenta identificar o início de um novo artigo/seção
                const isArticleStart = articleStartRegex.test(textContent);

                if (isArticleStart && currentArticleHtml !== '') {
                    // Se encontrarmos um novo artigo e já estamos coletando um,
                    // significa que o artigo anterior terminou.
                    articles.push({
                        originalHtml: currentArticleHtml,
                        normalizedText: normalizeText(currentArticleText)
                    });
                    // Reinicia para o novo artigo
                    currentArticleHtml = '';
                    currentArticleText = '';
                    isInsideArticle = false; // Reinicia a flag
                }
                
                // Se o nó atual é o início de um artigo ou se estamos dentro de um artigo
                if (isArticleStart || isInsideArticle) {
                    currentArticleHtml += outerHtml;
                    currentArticleText += textContent + ' ';
                    isInsideArticle = true; // Define a flag para indicar que estamos dentro de um artigo
                } else {
                    // Se não estamos dentro de um artigo e não é o início de um, 
                    // e o texto não é apenas espaçamento, considere como um bloco avulso.
                    // Isso pode ser ajustado dependendo se você quer que "preâmbulos" ou 
                    // textos antes do primeiro artigo sejam indexados como artigos separados.
                    articles.push({
                        originalHtml: outerHtml,
                        normalizedText: normalizeText(textContent)
                    });
                }
            });

            // Adiciona o último artigo, se houver
            if (currentArticleHtml !== '') {
                articles.push({
                    originalHtml: currentArticleHtml,
                    normalizedText: normalizeText(currentArticleText)
                });
            }
            return articles;
        }

        async function loadDocuments() {
            resultsContainer.innerHTML = '<p class="loading-message">Carregando documentos...</p>';
            try {
                loadedDocuments = [];
                documentSelector.innerHTML = '<option value="">Selecione um decreto/lei</option>';

                const fetches = documentFiles.map(async file => {
                    try {
                        const response = await fetch(`decretos/${file}`);
                        if (!response.ok) {
                            throw new Error(`Erro ${response.status} ao carregar ${file}: ${response.statusText}`);
                        }
                        const htmlText = await response.text();

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlText, 'text/html');

                        const docTitle = file.replace('.html', '');

                        // *** AQUI É A GRANDE MUDANÇA: Usamos a nova função extractArticles ***
                        const extractedArticles = extractArticles(doc);

                        loadedDocuments.push({
                            id: file, 
                            title: docTitle,
                            originalFullHtml: htmlText, 
                            articles: extractedArticles // Agora 'articles' contém unidades de artigo completo
                        });

                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = docTitle;
                        documentSelector.appendChild(option);
                    } catch (innerError) {
                        console.error(`Falha ao carregar ou processar o arquivo "${file}":`, innerError);
                    }
                });

                await Promise.all(fetches);
                console.log('Documentos carregados com sucesso!', loadedDocuments);
                resultsContainer.innerHTML = '<p class="no-results">Digite uma palavra-chave para iniciar a busca ou selecione um documento acima para visualizá-lo.</p>';

            } catch (error) {
                console.error('Erro geral ao carregar documentos:', error);
                resultsContainer.innerHTML = '<p class="no-results" style="color: red;">Erro ao carregar os documentos. Verifique o console para mais detalhes.</p>';
            }
        }

        function performSearch() {
            const searchTerm = normalizeText(searchInput.value.trim());
            resultsContainer.innerHTML = ''; 
            documentDisplay.style.display = 'none'; 
            documentSelector.value = ""; 

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<p class="no-results">Digite pelo menos 2 caracteres para buscar.</p>';
                return;
            }

            const resultsByDecree = {};

            loadedDocuments.forEach(doc => {
                const docTitle = doc.title;
                const highlightRegex = new RegExp(`(${searchInput.value.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                
                doc.articles.forEach(article => {
                    if (article.normalizedText.includes(searchTerm)) {
                        if (!resultsByDecree[doc.id]) {
                            resultsByDecree[doc.id] = {
                                title: docTitle,
                                foundArticles: []
                            };
                        }

                        // Criar uma cópia do HTML original do ARTIGO COMPLETO para manipular e adicionar o highlight
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = article.originalHtml; // Usa o HTML completo do artigo

                        const walk = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                        let node;
                        const nodesToReplace = [];

                        while (node = walk.nextNode()) {
                            const originalText = node.nodeValue;
                            // Previne que tags de highlight sejam criadas dentro de outras, 
                            // mas ainda permite que o texto dentro de tags HTML seja destacado.
                            // Isso é um pouco mais robusto.
                            if (node.parentNode.nodeName.toLowerCase() === 'span' && node.parentNode.classList.contains('highlight')) {
                                continue; // Já é um highlight, não faz nada
                            }

                            // Use um replace que cria um span para cada ocorrência da palavra
                            const newText = originalText.replace(highlightRegex, '<span class="highlight">$&</span>');
                            if (originalText !== newText) {
                                nodesToReplace.push({ node: node, newText: newText });
                            }
                        }

                        // Realiza as substituições de forma segura para não bagunçar o TreeWalker
                        nodesToReplace.forEach(item => {
                            const range = document.createRange();
                            range.selectNode(item.node);
                            const fragment = range.createContextualFragment(item.newText);
                            item.node.parentNode.replaceChild(fragment, item.node);
                        });

                        const highlightedArticleHtml = tempDiv.innerHTML;
                        
                        resultsByDecree[doc.id].foundArticles.push(highlightedArticleHtml);
                    }
                });
            });

            let totalFoundArticles = 0;
            for (const docId in resultsByDecree) {
                if (resultsByDecree.hasOwnProperty(docId)) {
                    const decreeData = resultsByDecree[docId];
                    totalFoundArticles += decreeData.foundArticles.length;

                    let decreeHtml = `
                        <div class="decree-results-quadrant">
                            <span class="decree-title">Decreto/Lei: ${decreeData.title}</span>
                    `;

                    decreeData.foundArticles.forEach(articleHtml => {
                        decreeHtml += `
                            <div class="document-card">
                                <span class="doc-reference">Artigo/Seção:</span>
                                <div class="found-paragraph">${articleHtml}</div>
                            </div>
                        `;
                    });

                    decreeHtml += `</div>`; 
                    resultsContainer.innerHTML += decreeHtml;
                }
            }

            if (totalFoundArticles === 0) {
                resultsContainer.innerHTML = `<p class="no-results">Nenhum resultado encontrado para "<strong>${searchInput.value}</strong>".</p>`;
            } else {
                resultsContainer.innerHTML = `<h2 style="text-align: left; color: #34495e;">Resultados da busca (${totalFoundArticles} encontrados)</h2>` + resultsContainer.innerHTML;
            }
        }

        function displaySelectedDocument() {
            const selectedFile = documentSelector.value;
            resultsContainer.innerHTML = ''; 
            searchInput.value = ''; 
            documentDisplay.style.display = 'block'; 

            if (selectedFile === "") {
                documentDisplay.innerHTML = '<p class="no-results">Selecione um documento para visualizá-lo.</p>';
                return;
            }

            const doc = loadedDocuments.find(d => d.id === selectedFile);
            if (doc) {
                documentDisplay.innerHTML = `<div class="document-full-content">${doc.originalFullHtml}</div>`;
            } else {
                documentDisplay.innerHTML = '<p class="no-results" style="color: red;">Erro: Documento não encontrado.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadDocuments);
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        documentSelector.addEventListener('change', displaySelectedDocument);
    </script>

</body>
</html>
